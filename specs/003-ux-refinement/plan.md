# Implementation Plan: UX Refinement — Splash, Grid, Images & Detail

**Branch**: `003-ux-refinement` | **Date**: 2026-02-21 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/003-ux-refinement/spec.md`

## Summary

Replace the default Flutter splash with a branded animated splash screen (EqualizerLoadingView on a warm background, using `flutter_native_splash` for the native layer). Convert the recipe list from a single-column 1.6:1 tile list to a 2-column square grid with larger text. Add fire-and-forget image prefetching for the first 10 photos. On the detail screen, move the recipe name into a gradient overlay on the hero photo, and display recipe tags as FilterChip widgets above the source attribution.

## Technical Context

**Language/Version**: Dart 3.9.2 / Flutter 3.35.6
**Primary Dependencies**:
- `flutter_riverpod 2.6.1` — state management (no codegen)
- `cached_network_image 3.3.x` — image display + disk cache (already in pubspec)
- `flutter_native_splash ^5.0.0` — **new dev_dependency** (generates native splash XML/storyboard; zero runtime overhead)
- `url_launcher 6.2.x`, `flutter_markdown 0.7.7+1`, `wakelock_plus 1.4.0` — unchanged
**Storage**: SharedPreferences (existing cache); no new storage
**Testing**: `flutter test` (unit + widget), `flutter test integration_test/` (acceptance)
**Target Platform**: Android (primary, API 24+), iOS (secondary)
**Performance Goals**: Images visible without reload on scroll-back; splash <2 s total
**Constraints**: No new runtime packages; `flutter analyze` zero warnings; `dart format` zero diffs; ≥80% coverage on changed files
**Scale/Scope**: ~3–50 recipes, 6 tag categories, 4 screens touched

## Constitution Check

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Code Quality | ✓ PASS | No dead code; single-responsibility widgets; no raw hard-coded colours (use `colorScheme.*`) |
| II. Test-First | ✓ PASS | Tasks ordered: failing tests written before each implementation block |
| III. UX Consistency | ✓ PASS | Gradient overlay pattern reused from existing `RecipeTile`; FilterChip from design system |
| IV. Performance | ✓ PASS | Image prefetch is fire-and-forget (no blocking); splash uses existing animation widget |

**Complexity Tracking**: No violations. `flutter_native_splash` is dev-only (no APK impact). No new abstractions introduced.

## Project Structure

### Documentation (this feature)

```text
specs/003-ux-refinement/
├── plan.md              ← this file
├── research.md          ← Phase 0 output
├── data-model.md        ← Phase 1 output
├── quickstart.md        ← Phase 1 output
├── checklists/
│   └── requirements.md
└── tasks.md             ← Phase 2 output (/speckit.tasks)
```

### Source Code (changes in this feature)

```text
pubspec.yaml                                 ← add flutter_native_splash dev_dependency + config
lib/
├── main.dart                                ← change home: SplashScreen (was RecipeListScreen)
├── screens/
│   ├── splash_screen.dart                   ← NEW: Flutter-side animated splash
│   ├── recipe_list_screen.dart              ← GridView.builder, image prefetch, padding tweaks
│   └── recipe_detail_screen.dart           ← name overlay on photo, tags param + FilterChips, remove heading
└── widgets/
    └── recipe_tile.dart                    ← childAspectRatio 1.0, larger name text

android/app/src/main/res/
└── drawable/launch_background.xml          ← generated by flutter_native_splash (warm background)
android/app/src/main/res/drawable-v21/
└── launch_background.xml                   ← generated by flutter_native_splash (v21 variant)
ios/Runner/Assets.xcassets/LaunchImage.imageset/  ← generated by flutter_native_splash

test/widget/
└── screens_widget_test.dart                ← updated for new widgets + parameters
integration_test/
└── app_test.dart                           ← updated/extended for US1–US4 acceptance
```

## Implementation Phases

### Phase 1: Native Splash Setup (US1 prerequisite)

Configure and generate the native splash assets.

1. Add to `pubspec.yaml` dev_dependencies: `flutter_native_splash: ^5.0.0`
2. Add config block in `pubspec.yaml`:
   ```yaml
   flutter_native_splash:
     color: "#F5EFE7"          # warm cream (matches _warmCreamSurface)
     color_dark: "#2B1F1A"     # warm dark surface
     android_12:
       color: "#F5EFE7"
       color_dark: "#2B1F1A"
     fullscreen: false
     android: true
     ios: true
   ```
3. Run: `dart run flutter_native_splash:create`

### Phase 2: Flutter-side Splash Screen (US1)

**New file**: `lib/screens/splash_screen.dart`

```
SplashScreen (ConsumerStatefulWidget)
  └─ Scaffold(backgroundColor: warmCream)
     └─ body: Center
        └─ Column(mainAxisSize: min)
           ├─ EqualizerLoadingView()      ← existing widget, reused
           └─ (loading text already in EqualizerLoadingView)
```

- Watch `appDataProvider` with `ref.listen` (not `ref.watch` to avoid rebuild loop)
- `appDataProvider.data` → push replacement to `RecipeListScreen`
- `appDataProvider.error` → show `ErrorView` with retry
- No timer/delay: splash plays exactly as long as data takes to load

**`lib/main.dart` change**: `home: const SplashScreen()` (was `const RecipeListScreen()`)

### Phase 3: Square 2-Column Grid (US2)

**`lib/widgets/recipe_tile.dart`**:
- `AspectRatio(aspectRatio: 1.0)` (was `1.6`)
- Name text: `titleMedium` (was `titleSmall`)
- Gradient overlay height `80px` (was implicit full-bottom); adjust `crossAxisAlignment` if needed

**`lib/screens/recipe_list_screen.dart`**:
- Replace `ListView.builder` with `GridView.builder`:
  ```dart
  GridView.builder(
    controller: _scrollController,
    gridDelegate: const SliverGridDelegateWithFixedCrossAxisCount(
      crossAxisCount: 2,
      childAspectRatio: 1.0,
      crossAxisSpacing: 8,
      mainAxisSpacing: 8,
    ),
    itemCount: recipes.length,
    itemBuilder: (_, i) => RecipeTile(recipe: recipes[i], onTap: () => ...),
  )
  ```
- Add `padding: const EdgeInsets.all(8)` on `GridView`
- Navigation push passes `tags: recipes[i].tags` (new parameter)

### Phase 4: Image Prefetch (US3)

**`lib/screens/recipe_list_screen.dart`** additions:
- Add `_prefetchDone` flag (bool field on state) to prefetch only once per data load
- In `data:` branch: call `_prefetchImages(recipes, context)` the first time data arrives
- `_prefetchImages`: takes first 10 non-null `picture` URLs, calls `precacheImage(CachedNetworkImageProvider(url), context).ignore()` for each

```dart
void _prefetchImages(List<RecipeSummary> recipes) {
  recipes
      .where((r) => r.picture != null)
      .take(10)
      .forEach((r) {
    precacheImage(CachedNetworkImageProvider(r.picture!), context).ignore();
  });
}
```

Import needed: `package:flutter/painting.dart` (for `precacheImage`) — already transitively available; `CachedNetworkImageProvider` from `cached_network_image`.

### Phase 5: Detail Screen — Name Overlay + Tags (US4)

**`lib/screens/recipe_detail_screen.dart`**:

New parameter: `final List<String> tags` (required, defaults to `const []`)

**Hero photo section** — add name overlay inside existing Stack:
```
Hero [Stack]
  ├─ AspectRatio(16/9) + CachedNetworkImage (unchanged)
  ├─ Positioned(bottom:0) gradient Container (unchanged)
  └─ Positioned(bottom:0) [NEW] Padding(16, 12) + Text(widget.name,
       style: headlineSmall, color: white, maxLines: 2, ellipsis)
```

**Remove**: `Padding(child: Text(widget.name, style: headlineMedium))` (the standalone heading)

**Tags section** — add between photo and source attribution:
```dart
if (widget.tags.isNotEmpty)
  Padding(
    padding: const EdgeInsets.fromLTRB(16, 12, 16, 0),
    child: Wrap(
      spacing: 8,
      runSpacing: 6,
      children: widget.tags.map((tag) => FilterChip(
        label: Text(tag),
        onSelected: (_) {
          ref.read(selectedTagsProvider.notifier).update((s) => {...s, tag});
          Navigator.pop(context);
        },
      )).toList(),
    ),
  ),
```

Source attribution `Padding` block remains below tags (unchanged).

## Key API Reference

| API | Source | Purpose |
|-----|--------|---------|
| `SliverGridDelegateWithFixedCrossAxisCount(crossAxisCount: 2, childAspectRatio: 1.0)` | flutter/widgets | Square 2-column grid |
| `precacheImage(CachedNetworkImageProvider(url), context).ignore()` | flutter/painting + cached_network_image | Fire-and-forget prefetch |
| `flutter_native_splash: dart run flutter_native_splash:create` | dev tool | Generates native launch screens |
| `FilterChip(label: Text(tag), onSelected: ...)` | flutter/material | Tag chips on detail screen |
| `Wrap(spacing: 8, runSpacing: 6, children: [...])` | flutter/widgets | Multi-line chip layout |
| `colorScheme.scrim.withValues(alpha: 0.65)` | flutter/material | Gradient overlay colour |

## Testing Strategy

### Widget Tests (screens_widget_test.dart)
- SplashScreen: shows EqualizerLoadingView while loading; transitions to RecipeListScreen on data
- RecipeTile: square aspect ratio; titleMedium text style
- RecipeListScreen: GridView (not ListView); 2 tiles per row
- RecipeDetailScreen: name text IN Hero subtree; no duplicate heading below photo; tags shown when non-empty; no tags section when empty; tapping tag chip pops screen with tag selected

### Integration Tests (app_test.dart)
- US1: Cold launch shows EqualizerLoadingView before list; back from list does not go to splash
- US2: List shows GridView with ≥2 items per row in portrait
- US3: Not easily testable in integration (network timing); covered by unit test for precacheImage call
- US4: Detail screen shows name overlay in Hero; shows tags; tapping tag returns to filtered list

## Post-Constitution Check

All four principles satisfied:
- **Quality**: No raw values; consistent pattern with RecipeTile gradient
- **Test-First**: All tasks sequenced test → implementation
- **UX Consistency**: Splash matches app colour scheme; chips match existing filter bar
- **Performance**: Prefetch is async fire-and-forget; no blocking on critical render path
