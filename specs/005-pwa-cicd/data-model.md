# Data Model: PWA Hosting & CI/CD Pipeline

**Feature**: 005-pwa-cicd
**Date**: 2026-02-21

This feature introduces no new Dart data models. It adds configuration files and a CI/CD workflow. The entities below are the files and configuration objects that must be created or modified.

---

## Entity 1: GitHub Actions Workflow

**File**: `.github/workflows/ci.yml`

**Fields**:

| Field | Value | Notes |
|-------|-------|-------|
| `name` | `Build, Test & Deploy` | Displayed in Actions tab |
| `on.push.branches` | `[main]` | Trigger: merge to main only |
| `permissions.contents` | `read` | Checkout access |
| `permissions.pages` | `write` | GitHub Pages deploy |
| `permissions.id-token` | `write` | OIDC token for Pages |

**Jobs**:

| Job ID | Name | Runner | `needs` | Purpose |
|--------|------|--------|---------|---------|
| `test` | Test & Analyze | `ubuntu-latest` | — | Run analyzer + all tests |
| `build-web` | Build & Deploy Web | `ubuntu-latest` | `test` | Build Flutter web + deploy Pages |
| `build-apk` | Build Android APK | `ubuntu-latest` | `test` | Build APK + upload artifact |

---

## Entity 2: Web Manifest

**File**: `web/manifest.json`

**Fields**:

| Field | Value |
|-------|-------|
| `name` | `niessl.org recipes` |
| `short_name` | `Recipes` |
| `start_url` | `/niessl.org.recipes/` |
| `scope` | `/niessl.org.recipes/` |
| `display` | `standalone` |
| `background_color` | `#F5EFE7` (warm cream surface) |
| `theme_color` | `#B85C38` (terracotta seed) |
| `icons[0].src` | `icons/Icon-192.png` |
| `icons[0].sizes` | `192x192` |
| `icons[0].purpose` | `any` |
| `icons[1].src` | `icons/Icon-512.png` |
| `icons[1].sizes` | `512x512` |
| `icons[1].purpose` | `any` |
| `icons[2].src` | `icons/Icon-maskable-192.png` |
| `icons[2].sizes` | `192x192` |
| `icons[2].purpose` | `maskable` |
| `icons[3].src` | `icons/Icon-maskable-512.png` |
| `icons[3].sizes` | `512x512` |
| `icons[3].purpose` | `maskable` |

**Validation rules**:
- `start_url` and `scope` MUST match the `--base-href` value used at build time
- `theme_color` MUST match the value in `web/index.html` `<meta name="theme-color">`
- All icon files MUST exist in `web/icons/` before build

---

## Entity 3: Web Index Page (modifications)

**File**: `web/index.html` (scaffolded by `flutter create --platforms=web`, then modified)

**Required additions** (in `<head>`):

| Tag | Value | Purpose |
|-----|-------|---------|
| `<meta name="theme-color">` | `#B85C38` | Browser toolbar colour |
| `<meta name="apple-mobile-web-app-capable">` | `yes` | iOS standalone mode |
| `<meta name="apple-mobile-web-app-status-bar-style">` | `black-translucent` | iOS status bar |
| `<meta name="apple-mobile-web-app-title">` | `niessl.org recipes` | iOS home screen label |
| `<link rel="apple-touch-icon">` | `icons/Icon-192.png` | iOS home screen icon |

**Note**: Flutter's scaffold includes `<link rel="manifest" href="manifest.json">` automatically.

---

## Entity 4: APK Artifact

**Produced at**: `build/app/outputs/apk/release/app-release.apk`

**Fields** (uploaded as GitHub Actions artifact):

| Field | Value |
|-------|-------|
| `name` | `niessl-recipes-apk` |
| `path` | `build/app/outputs/apk/release/app-release.apk` |
| `retention-days` | `90` |
| `if-no-files-found` | `error` |

**Constraints**:
- Must be installable on Android API level 21+ (set in `pubspec.yaml`: `min_sdk_android: 21`)
- Signed with Flutter's default debug keystore (acceptable for sideloading per spec)

---

## Entity 5: Web Build Output

**Produced at**: `build/web/` (git-ignored; generated by CI)

**Key generated files**:

| File | Purpose |
|------|---------|
| `build/web/index.html` | Entry point with `<base href="/niessl.org.recipes/">` injected |
| `build/web/main.dart.js` | Compiled Dart (minified in `--release`) |
| `build/web/flutter_service_worker.js` | Auto-generated by Flutter; caches app shell assets |
| `build/web/manifest.json` | Copied from `web/manifest.json` |
| `build/web/icons/` | Copied from `web/icons/` |
| `build/web/assets/` | App assets (including `logo.png`) |

---

## Entity 6: `pubspec.yaml` additions

**Section**: `flutter_launcher_icons.web`

| Field | Old Value | New Value |
|-------|-----------|-----------|
| `web.generate` | `false` | `true` |
| `web.image_path` | — | `"assets/logo.png"` |
| `web.background_color` | — | `"#F5EFE7"` |

These additions cause `dart run flutter_launcher_icons` to generate `web/icons/Icon-192.png`, `web/icons/Icon-512.png`, `web/icons/Icon-maskable-192.png`, and `web/icons/Icon-maskable-512.png`.

---

## State Transitions (Pipeline)

```
push to main
  └─ test job [RUNNING]
       ├─ PASS → build-web [RUNNING] + build-apk [RUNNING] (parallel)
       │           ├─ build-web PASS → GitHub Pages deployed
       │           └─ build-apk PASS → APK artifact uploaded (90-day retention)
       └─ FAIL → build-web [SKIPPED] + build-apk [SKIPPED]
                  (no deployment, no artifact, visible failure in Actions tab)
```
