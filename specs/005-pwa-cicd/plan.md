# Implementation Plan: PWA Hosting & CI/CD Pipeline

**Branch**: `005-pwa-cicd` | **Date**: 2026-02-21 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/005-pwa-cicd/spec.md`

## Summary

Add web platform support to the Flutter app and publish it as a PWA on GitHub Pages; create a GitHub Actions workflow that runs on merge to main, gates on tests passing, then deploys the web app and uploads a release APK as a CI artifact. No new Dart code is required — the work is: enable the `web` Flutter target, configure `web/manifest.json` and `web/index.html` for PWA compliance, update `flutter_launcher_icons` to generate web icons, and write a three-job CI workflow (test → build-web + build-apk in parallel).

## Technical Context

**Language/Version**: Dart 3.9.2 / Flutter 3.35.6
**Primary Dependencies**:
- `subosito/flutter-action@v4` — GitHub Actions Flutter setup (CI only)
- `actions/upload-pages-artifact@v3` + `actions/deploy-pages@v4` — GitHub Pages deployment
- `actions/upload-artifact@v4` — APK artifact upload
- `actions/checkout@v4` — source checkout in CI
- `flutter_launcher_icons ^0.14.0` — already in dev_dependencies; extend to generate web icons

**Storage**: N/A (no new storage; existing SharedPreferences cache unchanged)
**Testing**: `flutter test` (existing 94 tests); no new test framework needed; CI runs same suite
**Target Platform**: Web (new: GitHub Pages at `https://antipodos.github.io/niessl.org.recipes/`), Android API 21+ (existing, now also built by CI)
**Performance Goals**: App loads within 5 s on standard connection (SC-001); deploy completes within 10 min of merge (SC-001); APK available within 15 min (SC-003)
**Constraints**: `--base-href=/niessl.org.recipes/` required for subdirectory hosting; `flutter analyze` zero warnings; `dart format` zero diffs; all 94 tests must pass before any deployment
**Scale/Scope**: Single repository, one CI workflow file, three CI jobs, three web config files modified, one `pubspec.yaml` change

## Constitution Check

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Code Quality | ✓ PASS | No Dart source code changes; YAML/JSON/HTML files follow established patterns; no dead config |
| II. Test-First | ✓ PASS | No new behaviour is added to the Dart app; CI itself is verified by running it on merge; web config correctness is verified by Lighthouse audit (SC-002) — a specification-level acceptance test |
| III. UX Consistency | ✓ PASS | PWA manifest uses the exact same theme colour and branding established in feature 004; `display: standalone` matches native-app feel |
| IV. Performance | ✓ PASS | `--release --no-source-maps` builds optimised bundle; service worker (auto-generated) caches app shell; `--base-href` ensures no 404 asset errors that would degrade LCP |

**Complexity Tracking**: No violations. No new Dart abstractions. Flutter's built-in service worker satisfies FR-005 without a custom service worker. GitHub's first-party Pages actions are used; no third-party deployment dependencies introduced.

## Project Structure

### Documentation (this feature)

```text
specs/005-pwa-cicd/
├── plan.md              ← this file
├── research.md          ← Phase 0 output
├── data-model.md        ← Phase 1 output
├── quickstart.md        ← Phase 1 output
├── checklists/
│   └── requirements.md  ← spec quality gate (already passing)
└── tasks.md             ← Phase 2 output (/speckit.tasks)
```

### Source Code (new files and changes in this feature)

```text
.github/
└── workflows/
    └── ci.yml                           ← NEW: 3-job CI/CD workflow

web/                                     ← NEW directory (created by flutter create --platforms=web .)
├── index.html                           ← scaffolded + modified (Apple PWA meta tags, theme-color)
├── manifest.json                        ← scaffolded + modified (name, theme, icons, start_url, scope)
├── favicon.png                          ← scaffolded (default Flutter icon — acceptable placeholder)
└── icons/
    ├── Icon-192.png                     ← generated by flutter_launcher_icons (from assets/logo.png)
    ├── Icon-512.png                     ← generated by flutter_launcher_icons
    ├── Icon-maskable-192.png            ← generated by flutter_launcher_icons
    └── Icon-maskable-512.png            ← generated by flutter_launcher_icons

pubspec.yaml                             ← update flutter_launcher_icons.web section only
```

**No changes to `lib/`**, `test/`, `integration_test/`, or `android/`.

## Implementation Phases

### Phase 1: Enable Web Platform

Add the `web` Flutter target to the existing project.

1. Run `flutter create --platforms=web .` in the project root — scaffolds `web/` directory with `index.html`, `manifest.json`, and `icons/` without touching existing source files
2. Verify `web/index.html` and `web/manifest.json` are created
3. Run `flutter build web --release --base-href=/niessl.org.recipes/` to confirm web builds successfully (smoke test before any configuration)

### Phase 2: PWA Manifest & Index Configuration

Update the scaffolded web files with project-specific PWA metadata.

**`web/manifest.json`** — replace scaffolded defaults:
```json
{
  "name": "niessl.org recipes",
  "short_name": "Recipes",
  "start_url": "/niessl.org.recipes/",
  "scope": "/niessl.org.recipes/",
  "display": "standalone",
  "background_color": "#F5EFE7",
  "theme_color": "#B85C38",
  "icons": [
    { "src": "icons/Icon-192.png",          "sizes": "192x192", "type": "image/png", "purpose": "any" },
    { "src": "icons/Icon-512.png",          "sizes": "512x512", "type": "image/png", "purpose": "any" },
    { "src": "icons/Icon-maskable-192.png", "sizes": "192x192", "type": "image/png", "purpose": "maskable" },
    { "src": "icons/Icon-maskable-512.png", "sizes": "512x512", "type": "image/png", "purpose": "maskable" }
  ]
}
```

**`web/index.html`** — add in `<head>` (after existing `<link rel="manifest">`):
```html
<meta name="theme-color" content="#B85C38">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="niessl.org recipes">
<link rel="apple-touch-icon" href="icons/Icon-192.png">
```

### Phase 3: Web Icons

Enable web icon generation in `flutter_launcher_icons`.

**`pubspec.yaml`** — update `flutter_launcher_icons:` section:
```yaml
flutter_launcher_icons:
  android: true
  ios: true
  image_path: "assets/logo.png"
  adaptive_icon_background: "#FFFFFF"
  adaptive_icon_foreground: "assets/logo.png"
  min_sdk_android: 21
  web:
    generate: true
    image_path: "assets/logo.png"
    background_color: "#F5EFE7"
```

Run: `dart run flutter_launcher_icons`

This generates `web/icons/Icon-192.png`, `web/icons/Icon-512.png`, `web/icons/Icon-maskable-192.png`, `web/icons/Icon-maskable-512.png` from `assets/logo.png`.

### Phase 4: GitHub Actions Workflow

Create `.github/workflows/ci.yml`:

```yaml
name: Build, Test & Deploy

on:
  push:
    branches: [ main ]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  test:
    name: Test & Analyze
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v4
        with:
          flutter-version: '3.35.6'
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Run analyzer
        run: flutter analyze

      - name: Run tests
        run: flutter test

  build-web:
    name: Build & Deploy Web
    needs: test
    runs-on: ubuntu-latest
    timeout-minutes: 20
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v4
        with:
          flutter-version: '3.35.6'
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Build web
        run: flutter build web --release --base-href=/niessl.org.recipes/

      - name: Upload pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: build/web

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  build-apk:
    name: Build Android APK
    needs: test
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v4
        with:
          flutter-version: '3.35.6'
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Build APK
        run: flutter build apk --release

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: niessl-recipes-apk
          path: build/app/outputs/apk/release/app-release.apk
          retention-days: 90
          if-no-files-found: error
```

### Phase 5: Quality Gates

1. `flutter analyze` — must report zero issues
2. `dart format --set-exit-if-changed .` — must report zero diffs
3. `flutter build web --release --base-href=/niessl.org.recipes/` — must succeed locally
4. Manual Lighthouse audit of deployed GitHub Pages URL (SC-002)
5. Manual APK download and install from Actions run (US3 independent test)

## Key API Reference

| API / Tool | Purpose |
|-----------|---------|
| `flutter create --platforms=web .` | Scaffold `web/` directory in existing project |
| `flutter build web --release --base-href=/niessl.org.recipes/` | Compile Flutter web with correct subdirectory path |
| `dart run flutter_launcher_icons` | Generate `web/icons/` from `assets/logo.png` |
| `subosito/flutter-action@v4` | GitHub Actions: install Flutter with caching |
| `actions/upload-pages-artifact@v3` | GitHub Actions: package `build/web/` for Pages deployment |
| `actions/deploy-pages@v4` | GitHub Actions: deploy to GitHub Pages via OIDC |
| `actions/upload-artifact@v4` | GitHub Actions: attach APK to workflow run |
| `needs: test` | GitHub Actions: gate downstream jobs on test success |

## Testing Strategy

This feature contains no new Dart logic; the existing 94 tests are the test suite. The CI workflow itself is the integration test:

- **Unit/widget tests**: Pass gate on existing suite (`flutter test`) — no new tests needed
- **Pipeline test (US3 acceptance)**: Merge to main and verify Actions tab shows correct job statuses; download and install APK
- **PWA compliance test (US2 / SC-002)**: Lighthouse audit against the live GitHub Pages URL
- **Web app functional test (US1 acceptance)**: Manual walkthrough per `quickstart.md` US1 section

## Post-Constitution Check

All four principles satisfied post-design:
- **Quality**: No production Dart code changes; YAML/JSON config follows established conventions
- **Test-First**: Existing test suite acts as the gate; no new behaviour requires new tests
- **UX Consistency**: Manifest colours/name match the design system established in features 003 and 004
- **Performance**: Release build + service worker + CDN delivery via GitHub Pages satisfies LCP/TTI budgets; `--no-source-maps` reduces bundle size
